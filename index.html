<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="language" content="pl" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EmPeTrójniej</title>
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<body>
  <header>EmPeTrójniej</header>

  <main>
    <!-- Sekcja Gracze -->
    <section id="players">
      <div id="player-list"></div>
      <button id="add-player">Dodaj gracza</button>
      <button id="next-turn-btn">Następna tura</button>
      <button id="answer-btn">Odpowiada</button>
    </section>

    <!-- Sekcja Odtwarzacz dźwięków -->
    <section id="sounds">
      <table id="sound-table">
        <thead>
          <tr>
            <th>placeholder</th>
            <th>placeholder</th>
            <th>placeholder</th>
            <th>placeholder</th>
            <th>placeholder</th>
            <th>Typ</th>
          </tr>
        </thead>
      </table>

      <select id="sound-select"></select>
      <button id="play-sound">Odtwórz</button>
      <audio id="audio-player" controls></audio>

      <div id="quick-buttons">
        <button onclick="playFixedSound('sounds/correct.mp3')">Correct</button>
        <button onclick="playFixedSound('sounds/wrong.mp3')">Wrong</button>
        <button onclick="playFixedSound('sounds/yay.mp3')">Yay</button>
        <button onclick="playFixedSound('sounds/applause.mp3')">Brawa</button>
      </div>

      <div class="lifeline-description">
        <p><strong>KOŁA RATUNKOWE</strong></p>
        <ol>
          <li><span class="lifeline-emoji">#️⃣</span> Tagi gry</li>
          <li><span class="lifeline-emoji">📅</span> Rok wydania</li>
          <li><span class="lifeline-emoji">🎮</span> Platforma wydania</li>
        </ol>
      </div>
    </section>
  </main>

  <footer>Teleturniej Toczkensa. Created by SiemkaMati</footer>

  <script>
    // --- RĘCZNE ETYKIETY DLA KOLUMN TYPÓW ---
    const typeLabels = [
      'indie',
      'klasyka',
      'fps',
      'placeholder44',
      'placeholder55',
      'placeholder66',
      'placeholder77',
      'placeholder88'
    ];

    // --- ELEMENTY DOM ---
    const playerList    = document.getElementById("player-list");
    const addPlayerBtn  = document.getElementById("add-player");
    const nextTurnBtn   = document.getElementById("next-turn-btn");
    const answerBtn     = document.getElementById("answer-btn");
    const soundTable    = document.getElementById("sound-table");
    const soundSelect   = document.getElementById("sound-select");
    const playSoundBtn  = document.getElementById("play-sound");
    const audioPlayer   = document.getElementById("audio-player");

    // --- STAN APLIKACJI ---
    let players            = JSON.parse(localStorage.getItem("players"))      || [];
    let avatars            = [];
    let activeSounds       = JSON.parse(localStorage.getItem("activeSounds")) || [];
    let currentTurnIndex   = -1;
    let currentAnswerIndex = -1;

    // --- POMOCNICZE: ZAPIS DO localStorage ---
    function savePlayers() {
      localStorage.setItem("players", JSON.stringify(players));
    }
    function saveActiveSounds() {
      localStorage.setItem("activeSounds", JSON.stringify(activeSounds));
    }

    // --- ŁADUJ AVATAR.JSON ---
    fetch("avatars.json")
      .then(res => res.json())
      .then(data => avatars = data)
      .catch(err => console.error("Błąd avatarów:", err));

    // --- ŁADUJ SOUNDS.JSON I BUDUJ TABELĘ + SELECT ---
    fetch("sounds.json")
      .then(res => res.json())
      .then(files => {
        // grupowanie wg pierwszej cyfry
        const groups = {};
        files.forEach(f => {
          const match = f.match(/^(\d)/);
          const g = match ? match[1] : "_";
          if (!groups[g]) groups[g] = [];
          groups[g].push(f);
        });
        const sortedGroups = Object.keys(groups).sort();
        const maxRows = Math.max(...sortedGroups.map(g => groups[g].length));

        // twórz <tbody>
        const tbody = document.createElement("tbody");
        for (let row = 0; row < maxRows; row++) {
          const tr = document.createElement("tr");

          // kolumny dźwięków
          sortedGroups.forEach(g => {
            const td = document.createElement("td");
            const fname = groups[g][row];
            if (fname) {
              const path = `sounds/${fname}`;
              const btn = document.createElement("button");
              btn.textContent = fname
                .replace(/^\d+_/, "")
                .replace(/_/g, " ")
                .replace(".mp3", "");
              btn.onclick = () => toggleQuickSound(path, btn);
              if (activeSounds.includes(path)) btn.classList.add("active-sound");
              td.appendChild(btn);
            }
            tr.appendChild(td);
          });

          // kolumna Typ
          const typeTd = document.createElement("td");
          typeTd.textContent = typeLabels[row] || "";
          tr.appendChild(typeTd);

          tbody.appendChild(tr);
        }
        soundTable.appendChild(tbody);

        // uzupełnij select
        files.forEach(f => {
          const opt = document.createElement("option");
          opt.value = `sounds/${f}`;
          opt.textContent = f;
          soundSelect.appendChild(opt);
        });
      })
      .catch(err => console.error("Błąd przy ładowaniu dźwięków:", err));

    // --- FUNKCJE DŹWIĘKOWE ---
    function toggleQuickSound(path, btn) {
      const idx = activeSounds.indexOf(path);
      if (idx > -1) {
        audioPlayer.pause();
        audioPlayer.currentTime = 0;
        activeSounds.splice(idx, 1);
        btn.classList.remove("active-sound");
      } else {
        audioPlayer.src = path;
        audioPlayer.play();
        activeSounds.push(path);
        btn.classList.add("active-sound");
      }
      saveActiveSounds();
    }
    function playFixedSound(path) {
      audioPlayer.src = path;
      audioPlayer.play();
    }
    playSoundBtn.addEventListener("click", () => {
      audioPlayer.src = soundSelect.value;
      audioPlayer.play();
    });

    // --- WSKAŹNIKI TUR & ODPOWIADAJĄCEGO ---
    function updateIndicators() {
      document.querySelectorAll(".player").forEach((el, i) => {
        el.querySelector(".turn-indicator")
          .classList.toggle("active", i === currentTurnIndex);
        el.querySelector(".answer-indicator")
          .classList.toggle("active", i === currentAnswerIndex);
      });
    }
    function handleNext() {
      if (!players.length) return;
      currentTurnIndex = (currentTurnIndex + 1) % players.length;
      currentAnswerIndex = currentTurnIndex;
      updateIndicators();
    }
    function handleAnswer() {
      if (!players.length) return;
      currentAnswerIndex = (currentAnswerIndex + 1) % players.length;
      updateIndicators();
    }
    nextTurnBtn.addEventListener("click", handleNext);
    answerBtn.addEventListener("click", handleAnswer);

    // --- CRUD GRACZY ---
    function addPlayer() {
      const id = `player-${Date.now()}`;
      const avatar = avatars.length ? avatars[players.length % avatars.length] : null;
      const p = { id, name: `Gracz ${players.length+1}`, points: 0, avatar, lifelines: [false,false,false] };
      players.push(p);
      renderPlayer(p);
      savePlayers();
      updateIndicators();
    }
    addPlayerBtn.addEventListener("click", addPlayer);

    function renderPlayer(p) {
      const div = document.createElement("div");
      div.className = "player";
      div.id = p.id;

      const del = document.createElement("button");
      del.textContent = "X";
      del.className = "remove-button";
      del.onclick = () => removePlayer(p.id);

      const av = document.createElement("div");
      av.className = "player-avatar";
      av.style.backgroundImage = p.avatar ? `url('${p.avatar}')` : "none";
      av.onclick = () => showAvatarPicker(p, av);

      const nm = document.createElement("span");
      nm.className = "player-name";
      nm.textContent = p.name;
      nm.onclick = () => editPlayerName(p.id);

      const turnDot = document.createElement("span");
      turnDot.className = "indicator turn-indicator";
      turnDot.title = "Czyja jest tura";

      const ansDot = document.createElement("span");
      ansDot.className = "indicator answer-indicator";
      ansDot.title = "Kto odpowiada";

      const minus = document.createElement("button");
      minus.textContent = "-";
      minus.onclick = () => changeScore(p.id, -1);

      const pts = document.createElement("span");
      pts.className = "player-points";
      pts.id = `points-${p.id}`;
      pts.textContent = p.points;

      const plus = document.createElement("button");
      plus.textContent = "+";
      plus.onclick = () => changeScore(p.id, 1);

      const lfdiv = document.createElement("div");
      lfdiv.className = "lifelines";
      ["#️⃣","📅","🎮"].forEach((icon, i) => {
        const lf = document.createElement("div");
        lf.className = "lifeline";
        lf.dataset.index = i;
        if (p.lifelines[i]) {
          lf.classList.add("checked");
          lf.textContent = icon;
        }
        lf.onclick = () => {
          p.lifelines[i] = !p.lifelines[i];
          lf.classList.toggle("checked");
          lf.textContent = p.lifelines[i] ? icon : "";
          savePlayers();
        };
        lfdiv.appendChild(lf);
      });

      div.append(del, av, nm, turnDot, ansDot, minus, pts, plus, lfdiv);
      playerList.appendChild(div);
    }

    function removePlayer(playerId) {
    const player = players.find(p => p.id === playerId);
    // pokazujemy dialog potwierdzenia z imieniem gracza
    const msg = player
      ? `Czy na pewno chcesz usunąć gracza „${player.name}”?`
      : "Czy na pewno chcesz usunąć tego gracza?";
    if (!confirm(msg)) return;   // jeśli kliknie „Anuluj”, przerywamy

    // inaczej usuwamy
    players = players.filter(p => p.id !== playerId);
    document.getElementById(playerId).remove();
    savePlayers();
  }

    function editPlayerName(id) {
      const p = players.find(x => x.id === id);
      const span = document.querySelector(`#${id} .player-name`);
      const inp = document.createElement("input");
      inp.type = "text";
      inp.value = p.name;
      inp.className = "player-name-input";
      inp.onblur = () => {
        p.name = inp.value.trim() || p.name;
        span.textContent = p.name;
        inp.replaceWith(span);
        savePlayers();
      };
      inp.onkeypress = e => { if (e.key === "Enter") inp.blur(); };
      span.replaceWith(inp);
      inp.focus();
    }

    function changeScore(id, delta) {
      const p = players.find(x => x.id === id);
      p.points += delta;
      document.getElementById(`points-${id}`).textContent = p.points;
      savePlayers();
    }

    function showAvatarPicker(p, div) {
      document.querySelectorAll('.avatar-picker').forEach(x => x.remove());
      const picker = document.createElement("div");
      picker.className = "avatar-picker";
      avatars.forEach(url => {
        const opt = document.createElement("div");
        opt.className = "avatar-option";
        opt.style.backgroundImage = `url('${url}')`;
        opt.onclick = e => {
          e.stopPropagation();
          p.avatar = url;
          div.style.backgroundImage = `url('${url}')`;
          savePlayers();
          picker.remove();
        };
        picker.appendChild(opt);
      });
      div.appendChild(picker);
      setTimeout(() => {
        const fn = e => {
          if (!picker.contains(e.target)) {
            picker.remove();
            document.removeEventListener("click", fn);
          }
        };
        document.addEventListener("click", fn);
      }, 0);
    }

    // --- INIT ---
    window.addEventListener("DOMContentLoaded", () => {
      players.forEach(renderPlayer);
      updateIndicators();
    });
  </script>
</body>
</html>
