<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EmPeTrójniej</title>
  <link rel="stylesheet" href="css/style.css"/>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<body>
  <header>EmPeTrójniej</header>

  <main>
    <!-- Sekcja graczy -->
    <section id="players">
      <h2>Gracze</h2>
      <div id="player-list"></div>
      <button id="add-player">Dodaj gracza</button>
      <button id="next-turn-btn">Następna tura</button>
      <button id="answer-btn">Odpowiada</button>
    </section>

    <!-- Sekcja odtwarzacza dźwięków -->
    <section id="sounds">
      <h2>Odtwarzacz dźwięków</h2>
      <table id="sound-table"></table>
      <select id="sound-select"></select>
      <button id="play-sound">Odtwórz</button>
      <audio id="audio-player" controls></audio>
      <div id="quick-buttons">
        <button onclick="playFixedSound('sounds/correct.mp3')">Correct</button>
        <button onclick="playFixedSound('sounds/wrong.mp3')">Wrong</button>
        <button onclick="playFixedSound('sounds/yay.mp3')">Yay</button>
        <button onclick="playFixedSound('sounds/applause.mp3')">Brawa</button>
      </div>
      <div class="lifeline-description">
        <p><strong>KOŁA RATUNKOWE</strong></p>
        <ol>
          <li><span class="lifeline-emoji">#️⃣</span> Tagi gry</li>
          <li><span class="lifeline-emoji">📅</span> Rok wydania</li>
          <li><span class="lifeline-emoji">🎮</span> Platforma wydania</li>
        </ol>
      </div>
    </section>
  </main>

  <footer>Teleturniej Toczkensa. Created by SiemkaMati</footer>

  <script>
    // --- DOM ---
    const playerList    = document.getElementById("player-list");
    const addBtn        = document.getElementById("add-player");
    const nextBtn       = document.getElementById("next-turn-btn");
    const answerBtn     = document.getElementById("answer-btn");
    const soundTable    = document.getElementById("sound-table");
    const soundSelect   = document.getElementById("sound-select");
    const playSoundBtn  = document.getElementById("play-sound");
    const audioPlayer   = document.getElementById("audio-player");

    // --- STAN APLIKACJI ---
    let currentTurnIndex   = -1;
    let currentAnswerIndex = -1;
    let players            = [];
    let avatars            = [];
    let activeSounds       = [];

    // --- LOCALSTORAGE ---
    function loadStorage() {
      players      = JSON.parse(localStorage.getItem("players"))      || [];
      activeSounds = JSON.parse(localStorage.getItem("activeSounds")) || [];
    }
    function savePlayers()      { localStorage.setItem("players", JSON.stringify(players)); }
    function saveActiveSounds() { localStorage.setItem("activeSounds", JSON.stringify(activeSounds)); }

    // wczytaj stan od razu, by activeSounds było dostępne przy budowie UI
    loadStorage();

    // --- FETCH AVATARÓW ---
    fetch("avatars.json")
      .then(r => r.json())
      .then(data => avatars = data)
      .catch(err => console.error("Błąd avatarów:", err));

    // --- GENERUJ SOUND TABLE + SELECT ---
    fetch("sounds.json")
      .then(r => r.json())
      .then(files => {
        // pogrupuj wg pierwszej cyfry w nazwie
        const groups = {};
        files.forEach(f => {
          const g = f.match(/^(\d)/)?.[1] || '_';
          (groups[g] = groups[g] || []).push(f);
        });
        const maxRows = Math.max(...Object.values(groups).map(a => a.length));
        for (let row = 0; row < maxRows; row++) {
          const tr = document.createElement("tr");
          Object.keys(groups).sort().forEach(g => {
            const td = document.createElement("td");
            const fname = groups[g][row];
            if (fname) {
              const path = `sounds/${fname}`;
              const btn = document.createElement("button");
              btn.textContent = fname
                .replace(/^\d+_/, "")
                .replace(/_/g, " ")
                .replace(".mp3", "");
              btn.onclick = () => playQuickSound(path, btn);
              if (activeSounds.includes(path)) btn.classList.add("active-sound");
              td.appendChild(btn);
            }
            tr.appendChild(td);
          });
          soundTable.appendChild(tr);
        }
        // wypełnij select
        files.forEach(f => {
          const opt = document.createElement("option");
          opt.value = `sounds/${f}`;
          opt.textContent = f;
          soundSelect.appendChild(opt);
        });
      })
      .catch(err => console.error("Błąd przy ładowaniu dźwięków:", err));

    // --- AKCJE DŹWIĘKOWE ---
    function playQuickSound(path, btn) {
      const idx = activeSounds.indexOf(path);
      if (idx > -1) {
        audioPlayer.pause();
        audioPlayer.currentTime = 0;
        activeSounds.splice(idx, 1);
        btn.classList.remove("active-sound");
      } else {
        audioPlayer.src = path;
        audioPlayer.play();
        activeSounds.push(path);
        btn.classList.add("active-sound");
      }
      saveActiveSounds();
    }
    function playFixedSound(path) {
      audioPlayer.src = path;
      audioPlayer.play();
    }
    playSoundBtn.addEventListener("click", () => {
      audioPlayer.src = soundSelect.value;
      audioPlayer.play();
    });

    // --- WSKAŹNIKI TUR I ODPOWIADAJĄCEGO ---
    function updateIndicators() {
      const items = playerList.querySelectorAll('.player');
      items.forEach((el, i) => {
        el.querySelector('.turn-indicator')
          .classList.toggle('active', i === currentTurnIndex);
        el.querySelector('.answer-indicator')
          .classList.toggle('active', i === currentAnswerIndex);
      });
    }

    function handleNext() {
      const count = players.length;
      if (!count) return;
      currentTurnIndex = (currentTurnIndex + 1) % count;
      currentAnswerIndex = currentTurnIndex;
      updateIndicators();
    }

    function handleAnswer() {
      const count = players.length;
      if (!count) return;
      currentAnswerIndex = (currentAnswerIndex + 1) % count;
      updateIndicators();
    }

    nextBtn.addEventListener("click", handleNext);
    answerBtn.addEventListener("click", handleAnswer);

    // --- DODAWANIE, RENDER, EDYCJA GRACZA ---
    function addPlayer() {
      const id = `player-${Date.now()}`;
      const avatar = avatars.length ? avatars[players.length % avatars.length] : null;
      const p = { id, name: `Gracz ${players.length+1}`, points: 0, avatar, lifelines: [false,false,false] };
      players.push(p);
      renderPlayer(p);
      savePlayers();
      updateIndicators();
    }
    addBtn.addEventListener("click", addPlayer);

    function renderPlayer(p) {
      const div = document.createElement("div");
      div.className = "player";
      div.id = p.id;

      const del = document.createElement("button");
      del.textContent = "X"; del.className = "remove-button";
      del.onclick = () => removePlayer(p.id);

      const av = document.createElement("div");
      av.className = "player-avatar";
      av.style.backgroundImage = p.avatar ? `url('${p.avatar}')` : "none";
      av.onclick = () => showAvatarPicker(p, av);

      const nm = document.createElement("span");
      nm.className = "player-name"; nm.textContent = p.name;
      nm.onclick = () => editName(p.id);

      const turnDot = document.createElement("span");
      turnDot.className = "indicator turn-indicator";
      turnDot.title = "Czyja jest tura";

      const ansDot = document.createElement("span");
      ansDot.className = "indicator answer-indicator";
      ansDot.title = "Kto odpowiada";

      const minus = document.createElement("button");
      minus.textContent = "-"; minus.onclick = () => changeScore(p.id, -1);

      const pts = document.createElement("span");
      pts.className = "player-points"; pts.id = `points-${p.id}`;
      pts.textContent = p.points;

      const plus = document.createElement("button");
      plus.textContent = "+"; plus.onclick = () => changeScore(p.id, 1);

      const lfdiv = document.createElement("div");
      lfdiv.className = "lifelines";
      ["#️⃣","📅","🎮"].forEach((icon,i) => {
        const lf = document.createElement("div");
        lf.className = "lifeline";
        lf.dataset.index = i;
        if (p.lifelines[i]) {
          lf.classList.add("checked");
          lf.textContent = icon;
        }
        lf.onclick = () => {
          p.lifelines[i] = !p.lifelines[i];
          lf.classList.toggle("checked");
          lf.textContent = p.lifelines[i] ? icon : "";
          savePlayers();
        };
        lfdiv.appendChild(lf);
      });

      div.append(del, av, nm, turnDot, ansDot, minus, pts, plus, lfdiv);
      playerList.appendChild(div);
    }

    function removePlayer(id) {
      players = players.filter(p => p.id !== id);
      document.getElementById(id).remove();
      savePlayers();
      updateIndicators();
    }

    function editName(id) {
      const p = players.find(x => x.id === id);
      const span = document.querySelector(`#${id} .player-name`);
      const inp = document.createElement("input");
      inp.type = "text"; inp.value = p.name; inp.className = "player-name-input";
      inp.onblur = () => {
        p.name = inp.value.trim() || p.name;
        span.textContent = p.name;
        inp.replaceWith(span);
        savePlayers();
      };
      inp.onkeypress = e => { if (e.key === "Enter") inp.blur(); };
      span.replaceWith(inp);
      inp.focus();
    }

    function changeScore(id, delta) {
      const p = players.find(x => x.id === id);
      p.points += delta;
      document.getElementById(`points-${id}`).textContent = p.points;
      savePlayers();
    }

    function showAvatarPicker(p, div) {
      document.querySelectorAll('.avatar-picker').forEach(x => x.remove());
      const picker = document.createElement("div");
      picker.className = "avatar-picker";
      avatars.forEach(url => {
        const opt = document.createElement("div");
        opt.className = "avatar-option";
        opt.style.backgroundImage = `url('${url}')`;
        opt.onclick = e => {
          e.stopPropagation();
          p.avatar = url;
          div.style.backgroundImage = `url('${url}')`;
          savePlayers();
          picker.remove();
        };
        picker.appendChild(opt);
      });
      div.appendChild(picker);
      setTimeout(() => {
        const fn = e => {
          if (!picker.contains(e.target)) {
            picker.remove();
            document.removeEventListener("click", fn);
          }
        };
        document.addEventListener("click", fn);
      }, 0);
    }

    // --- INIT ---
    window.addEventListener("DOMContentLoaded", () => {
      loadStorage();
      players.forEach(renderPlayer);
      updateIndicators();
    });
  </script>
</body>
</html>
